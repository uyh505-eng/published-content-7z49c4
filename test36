local repo = "https://raw.githubusercontent.com/deividcomsono/Obsidian/main/"
local Library = loadstring(game:HttpGet(repo .. "Library.lua"))()
local ThemeManager = loadstring(game:HttpGet(repo .. "addons/ThemeManager.lua"))()
local SaveManager = loadstring(game:HttpGet(repo .. "addons/SaveManager.lua"))()

-- Load the COMBO_WICK Module
local Module = loadstring(game:HttpGet("https://raw.githubusercontent.com/checkurasshole/Trt/refs/heads/main/yes"))()

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")
local Camera = Workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer

local Options = Library.Options
local Toggles = Library.Toggles

-- Restricted Game Check
local IS_RESTRICTED_GAME = (game.PlaceId == 136801880565837)
local IsMobile = UserInputService.TouchEnabled

local Window = Library:CreateWindow({
    Title = "COMBO_WICK | Tactical AIO (Unified)",
    Footer = "Universal Mobile & PC Support",
    Icon = 95816097006870,
    NotifySide = "Right",
    ShowCustomCursor = not IsMobile, 
    MobileButtonsSide = "Right"
})

local Tabs = {
    Main = Window:AddTab("Combat", "crosshair"),
    Visuals = Window:AddTab("Visuals", "eye"),
    ["UI Settings"] = Window:AddTab("UI Settings", "settings"),
}

Module.Initialize(Library, Options, Toggles)

local FOVCircle = Drawing.new("Circle")
FOVCircle.Visible = false
FOVCircle.Thickness = 1
FOVCircle.NumSides = 64
FOVCircle.Filled = false
FOVCircle.Transparency = 0.7
FOVCircle.Color = Color3.fromRGB(255, 255, 255)

local StickyTarget = nil
local ESP_Cache = {}
local LOBBY_THRESHOLD = 450

-- Logic to find screen center accurately
local function GetCenter()
    return Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y / 2)
end

local function IsInSafeZone(Player)
    if not Player or not Player.Character then return false end
    local Root = Player.Character:FindFirstChild("HumanoidRootPart")
    if not Root then return false end
    
    local Pos = Root.Position
    local function getCenterObj(obj)
        if not obj then return nil end
        if obj:IsA("BasePart") then return obj.Position end
        local part = obj:FindFirstChildWhichIsA("BasePart", true)
        return part and part.Position
    end

    local targetObjects = {
        Workspace:FindFirstChild("Lobby"),
        (Workspace:FindFirstChild("Lobby") and Workspace.Lobby:FindFirstChild("SpawnLocation"))
    }

    for _, obj in pairs(targetObjects) do
        if obj then
            local center = getCenterObj(obj)
            if center and (Pos - center).Magnitude < LOBBY_THRESHOLD then
                return true
            end
        end
    end
    return false
end

local function GetRainbowColor()
    local hue = tick() % 5 / 5
    return Color3.fromHSV(hue, 1, 1)
end

local function IsTeammate(Player)
    if not Toggles.TeamCheck.Value then return false end
    if Player.Team == LocalPlayer.Team and Player.Team ~= nil then return true end
    if Player:GetAttribute("Team") == LocalPlayer:GetAttribute("Team") and Player:GetAttribute("Team") ~= nil then return true end
    local Char = Player.Character
    if Char then
        local HRP = Char:FindFirstChild("HumanoidRootPart")
        if HRP and (HRP:FindFirstChild("teamatelabel") or HRP:FindFirstChild("TeammateLabel") or HRP:FindFirstChild("Marker")) then return true end
    end
    return false
end

local function hasWallObstruction(targetPart)
    if not Toggles.WallCheck.Value then return false end
    local MyChar = LocalPlayer.Character
    if not MyChar then return true end
    local rayParams = RaycastParams.new()
    rayParams.FilterDescendantsInstances = {MyChar, targetPart.Parent}
    rayParams.FilterType = Enum.RaycastFilterType.Exclude
    local origin = Camera.CFrame.Position
    local rayResult = Workspace:Raycast(origin, (targetPart.Position - origin), rayParams)
    return rayResult and not rayResult.Instance:IsDescendantOf(targetPart.Parent)
end

local function GetClosestTarget()
    if IsInSafeZone(LocalPlayer) then return nil end
    local Target, Closest = nil, Options.AimbotFOV.Value
    local ScreenCenter = GetCenter()

    for _, p in pairs(Players:GetPlayers()) do
        if p ~= LocalPlayer and p.Character and p.Character:FindFirstChild("HumanoidRootPart") and p.Character:FindFirstChild("Humanoid") and p.Character.Humanoid.Health > 0 then
            if IsInSafeZone(p) or IsTeammate(p) then continue end
            local targetPart = p.Character:FindFirstChild(Options.AimPart.Value) or p.Character.HumanoidRootPart
            if hasWallObstruction(targetPart) then continue end
            
            local Pos, OnScreen = Camera:WorldToViewportPoint(targetPart.Position)
            if OnScreen then
                local Dist = (Vector2.new(Pos.X, Pos.Y) - ScreenCenter).Magnitude
                if Dist < Closest then Closest = Dist; Target = p end
            end
        end
    end
    return Target
end

-- Check if target is alive (helper for trigger bot)
local function IsAlive(player)
    if not player or not player.Character then return false end
    local humanoid = player.Character:FindFirstChild("Humanoid")
    return humanoid and humanoid.Health > 0
end

-- UI ELEMENTS
local AimGroup = Tabs.Main:AddLeftGroupbox("Aimbot Settings")
AimGroup:AddToggle("AimbotEnabled", { Text = "Enabled", Default = false })
AimGroup:AddToggle("AlwaysOn", { Text = "Always On (Auto-Lock)", Default = false })
if not IsMobile then
    AimGroup:AddDropdown("AimMethod", { Values = {"Camera", "Mouse", "Hybrid"}, Default = 3, Text = "Aim Method" })
end
AimGroup:AddToggle("TeamCheck", { Text = "Team Check", Default = true })
AimGroup:AddToggle("WallCheck", { Text = "Visibility Check", Default = true })
AimGroup:AddSlider("AimbotFOV", { Text = "FOV Size", Default = 150, Min = 0, Max = 1000 })
AimGroup:AddSlider("Smoothing", { Text = "Smoothness", Default = 2, Min = 1, Max = 20, Rounding = 1 })
AimGroup:AddDropdown("AimPart", { Values = {"Head", "HumanoidRootPart"}, Default = 1, Text = "Target Part" })

if not IsMobile then
    AimGroup:AddLabel("Aim Keybind"):AddKeyPicker("AimKey", { Default = "MB2", Mode = "Hold", Text = "Aim Lock" })
end

if not IS_RESTRICTED_GAME then
    local KillGroup = Tabs.Main:AddRightGroupbox("KILL V1 (OP)")
    KillGroup:AddToggle("KillV1Enabled", { Text = "Enabled", Default = false })
    KillGroup:AddSlider("KillHeight", { Text = "Height Above Head", Default = 6, Min = 2, Max = 20, Rounding = 1 })

    local HitGroup = Tabs.Main:AddRightGroupbox("Hitbox Expander")
    HitGroup:AddToggle("HitboxEnabled", { Text = "Enabled", Default = false })
    HitGroup:AddSlider("HitboxSize", { Text = "Hitbox Size", Default = 2, Min = 2, Max = 20, Rounding = 1 })
    HitGroup:AddSlider("HitboxTransparency", { Text = "Hitbox Transparency", Default = 0.5, Min = 0, Max = 1, Rounding = 1 })
    HitGroup:AddLabel("Hitbox Color"):AddColorPicker("HitboxColor", { Default = Color3.fromRGB(255, 0, 0) })
end

local LoopGroup = Tabs.Main:AddRightGroupbox("Auto Play & Shoot")
LoopGroup:AddToggle("AutoPlay", { Text = "Auto Play Loop", Default = false })
LoopGroup:AddToggle("TriggerBot", { Text = "Auto Shoot (On Lock)", Default = false })
LoopGroup:AddSlider("TriggerDelay", { Text = "Delay (ms)", Default = 50, Min = 0, Max = 500, Rounding = 0 })

local VisGroup = Tabs.Visuals:AddLeftGroupbox("Visuals")
VisGroup:AddToggle("VisBox", { Text = "Corner Brackets", Default = false })
VisGroup:AddToggle("VisSkeleton", { Text = "Skeleton ESP", Default = false })
VisGroup:AddToggle("VisHealth", { Text = "Dynamic Health Bar", Default = false })
VisGroup:AddToggle("VisName", { Text = "Tactical Info Tags", Default = false })
VisGroup:AddToggle("VisTracer", { Text = "Tracers", Default = false })
VisGroup:AddToggle("VisHead", { Text = "Head Indicator", Default = false })
VisGroup:AddToggle("VisChams", { Text = "Player Chams", Default = false })
VisGroup:AddSlider("VisMaxDist", { Text = "Max ESP Distance", Default = 500, Min = 100, Max = 5000, Rounding = 0 })

local RainbowGroup = Tabs.Visuals:AddRightGroupbox("Rainbow Visuals")
RainbowGroup:AddToggle("RainbowESP", { Text = "Rainbow Highlight ESP", Default = false })
RainbowGroup:AddToggle("RainbowTracers", { Text = "Rainbow Tracers", Default = false })

local ColorGroup = Tabs.Visuals:AddRightGroupbox("Colors")
ColorGroup:AddLabel("Enemy Color"):AddColorPicker("EnemyCol", { Default = Color3.fromRGB(255, 50, 50) })
ColorGroup:AddLabel("Team Color"):AddColorPicker("TeamCol", { Default = Color3.fromRGB(50, 255, 50) })

local function RemoveESP(Player)
    if ESP_Cache[Player] then
        for _, obj in pairs(ESP_Cache[Player]) do
            if typeof(obj) == "table" then for _, v in pairs(obj) do if v.Remove then v:Remove() end end
            elseif typeof(obj) == "Instance" then obj:Destroy()
            elseif obj.Remove then obj:Remove() end
        end
        ESP_Cache[Player] = nil
    end
end

-- MAIN LOOP
RunService:BindToRenderStep("UnifiedRender", Enum.RenderPriority.Camera.Value + 1, function()
    local LocalInLobby = IsInSafeZone(LocalPlayer)
    local rainbowCol = GetRainbowColor()
    local CenterPos = GetCenter()

    Module.autoPlayEnabled = Toggles.AutoPlay.Value
    
    FOVCircle.Visible = Toggles.AimbotEnabled.Value and not LocalInLobby
    FOVCircle.Position = CenterPos
    FOVCircle.Radius = Options.AimbotFOV.Value

    -- AIMBOT ACTIVE CHECK
    local AimActive = false
    if Toggles.AimbotEnabled.Value and not LocalInLobby then
        if IsMobile then
            AimActive = true -- Always active on mobile if enabled
        else
            AimActive = Toggles.AlwaysOn.Value or (Options.AimKey and Options.AimKey:GetState())
        end
    end

    if AimActive then
        local NewTarget = GetClosestTarget()
        if NewTarget then StickyTarget = NewTarget end
    end
    if StickyTarget then
        local Hum = StickyTarget.Character and StickyTarget.Character:FindFirstChild("Humanoid")
        if not StickyTarget.Character or not Hum or Hum.Health <= 0 or IsInSafeZone(StickyTarget) then StickyTarget = nil end
    end
    if not AimActive then StickyTarget = nil end

    -- KILL V1
    if not IS_RESTRICTED_GAME and Toggles.KillV1Enabled.Value and StickyTarget and StickyTarget.Character and not LocalInLobby then
        local MyRoot = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
        local TargetHead = StickyTarget.Character:FindFirstChild("Head")
        if MyRoot and TargetHead then
            MyRoot.CFrame = CFrame.lookAt(TargetHead.Position + Vector3.new(0, Options.KillHeight.Value, 0), TargetHead.Position)
            MyRoot.Anchored = true
        end
    elseif LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        LocalPlayer.Character.HumanoidRootPart.Anchored = false
    end

    -- AIMBOT EXECUTION
    if AimActive and StickyTarget then
        local Part = StickyTarget.Character:FindFirstChild(Options.AimPart.Value)
        if Part and not hasWallObstruction(Part) then
            if IsMobile or Options.AimMethod.Value == "Camera" or Options.AimMethod.Value == "Hybrid" then
                Camera.CFrame = Camera.CFrame:Lerp(CFrame.new(Camera.CFrame.Position, Part.Position), 1/Options.Smoothing.Value)
            end
            
            if not IsMobile and (Options.AimMethod.Value == "Mouse" or Options.AimMethod.Value == "Hybrid") and mousemoverel then
                local ScreenPos = Camera:WorldToViewportPoint(Part.Position)
                mousemoverel((ScreenPos.X - CenterPos.X) / Options.Smoothing.Value, (ScreenPos.Y - CenterPos.Y) / Options.Smoothing.Value)
            end
        end
    end

    -- ESP PROCESSOR
    for _, Player in pairs(Players:GetPlayers()) do
        if Player == LocalPlayer then continue end
        local Char = Player.Character
        local Root = Char and Char:FindFirstChild("HumanoidRootPart")
        local Hum = Char and Char:FindFirstChild("Humanoid")
        
        if not Root or not Hum or Hum.Health <= 0 or IsInSafeZone(Player) then 
            RemoveESP(Player) continue 
        end

        local Dist = (Camera.CFrame.Position - Root.Position).Magnitude
        if Dist > Options.VisMaxDist.Value then RemoveESP(Player) continue end

        local Pos, OnScreen = Camera:WorldToViewportPoint(Root.Position)
        if OnScreen then
            if not ESP_Cache[Player] then
                ESP_Cache[Player] = {
                    Corners = { Drawing.new("Line"), Drawing.new("Line"), Drawing.new("Line"), Drawing.new("Line"), Drawing.new("Line"), Drawing.new("Line"), Drawing.new("Line"), Drawing.new("Line") },
                    Skeleton = { Drawing.new("Line"), Drawing.new("Line"), Drawing.new("Line"), Drawing.new("Line"), Drawing.new("Line") },
                    HealthBar = Drawing.new("Line"), Name = Drawing.new("Text"), Tracer = Drawing.new("Line"), HeadDot = Drawing.new("Circle"),
                    Chams = Instance.new("Highlight", game:GetService("CoreGui"))
                }
            end
            
            local Obj = ESP_Cache[Player]
            local MainCol = Toggles.RainbowESP.Value and rainbowCol or (IsTeammate(Player) and Options.TeamCol.Value or Options.EnemyCol.Value)
            local Scale = 1/Pos.Z * 1000
            local W, H = 2.5 * Scale, 4.5 * Scale
            local X, Y = Pos.X - W/2, Pos.Y - H/2

            for _, v in pairs(Obj.Corners) do v.Visible = Toggles.VisBox.Value; v.Color = MainCol; v.Thickness = (IsMobile and 2 or 1) end
            if Toggles.VisBox.Value then
                local L = W/4
                Obj.Corners[1].From = Vector2.new(X, Y); Obj.Corners[1].To = Vector2.new(X+L, Y)
                Obj.Corners[2].From = Vector2.new(X, Y); Obj.Corners[2].To = Vector2.new(X, Y+L)
                Obj.Corners[3].From = Vector2.new(X+W, Y); Obj.Corners[3].To = Vector2.new(X+W-L, Y)
                Obj.Corners[4].From = Vector2.new(X+W, Y); Obj.Corners[4].To = Vector2.new(X+W, Y+L)
                Obj.Corners[5].From = Vector2.new(X, Y+H); Obj.Corners[5].To = Vector2.new(X+L, Y+H)
                Obj.Corners[6].From = Vector2.new(X, Y+H); Obj.Corners[6].To = Vector2.new(X, Y+H-L)
                Obj.Corners[7].From = Vector2.new(X+W, Y+H); Obj.Corners[7].To = Vector2.new(X+W-L, Y+H)
                Obj.Corners[8].From = Vector2.new(X+W, Y+H); Obj.Corners[8].To = Vector2.new(X+W, Y+H-L)
            end

            for _, v in pairs(Obj.Skeleton) do v.Visible = Toggles.VisSkeleton.Value; v.Color = Color3.new(1,1,1); v.Thickness = (IsMobile and 2 or 1) end
            if Toggles.VisSkeleton.Value then
                local function GB(n) local p = Char:FindFirstChild(n) return p and Camera:WorldToViewportPoint(p.Position) end
                local Head, Torso, LL, RL, LA, RA = GB("Head"), GB("UpperTorso") or GB("Torso"), GB("LeftLowerLeg") or GB("Left Leg"), GB("RightLowerLeg") or GB("Right Leg"), GB("LeftLowerArm") or GB("Left Arm"), GB("RightLowerArm") or GB("Right Arm")
                if Head and Torso and LL and RL and LA and RA then
                    Obj.Skeleton[1].From = Vector2.new(Head.X, Head.Y); Obj.Skeleton[1].To = Vector2.new(Torso.X, Torso.Y)
                    Obj.Skeleton[2].From = Vector2.new(Torso.X, Torso.Y); Obj.Skeleton[2].To = Vector2.new(LL.X, LL.Y)
                    Obj.Skeleton[3].From = Vector2.new(Torso.X, Torso.Y); Obj.Skeleton[3].To = Vector2.new(RL.X, RL.Y)
                    Obj.Skeleton[4].From = Vector2.new(Torso.X, Torso.Y); Obj.Skeleton[4].To = Vector2.new(LA.X, LA.Y)
                    Obj.Skeleton[5].From = Vector2.new(Torso.X, Torso.Y); Obj.Skeleton[5].To = Vector2.new(RA.X, RA.Y)
                end
            end

            Obj.HealthBar.Visible = Toggles.VisHealth.Value
            if Toggles.VisHealth.Value then
                Obj.HealthBar.From = Vector2.new(X-5, Y+H); Obj.HealthBar.To = Vector2.new(X-5, Y+H-(Hum.Health/Hum.MaxHealth*H))
                Obj.HealthBar.Color = Color3.fromHSV(math.clamp(Hum.Health/Hum.MaxHealth,0,0.35),0.9,0.9); Obj.HealthBar.Thickness = (IsMobile and 3 or 2)
            end

            Obj.Tracer.Visible = Toggles.VisTracer.Value or Toggles.RainbowTracers.Value
            if Obj.Tracer.Visible then
                Obj.Tracer.From = Vector2.new(CenterPos.X, Camera.ViewportSize.Y); Obj.Tracer.To = Vector2.new(Pos.X, Pos.Y)
                Obj.Tracer.Color = Toggles.RainbowTracers.Value and rainbowCol or MainCol
                Obj.Tracer.Thickness = (IsMobile and 2 or 1)
            end

            -- FIXED: Head Indicator - Hollow Circle
            Obj.HeadDot.Visible = Toggles.VisHead.Value
            if Toggles.VisHead.Value and Char:FindFirstChild("Head") then
                local HPos = Camera:WorldToViewportPoint(Char.Head.Position)
                Obj.HeadDot.Position = Vector2.new(HPos.X, HPos.Y)
                Obj.HeadDot.Radius = Scale * 0.6
                Obj.HeadDot.Color = MainCol
                Obj.HeadDot.Thickness = (IsMobile and 2 or 1)
                Obj.HeadDot.Filled = false
                Obj.HeadDot.Transparency = 1
                Obj.HeadDot.NumSides = 32
            end

            Obj.Name.Visible = Toggles.VisName.Value
            if Toggles.VisName.Value then
                Obj.Name.Text = Player.Name:upper() .. " [" .. math.floor(Dist) .. "M]"
                Obj.Name.Position = Vector2.new(Pos.X, Y-20); Obj.Name.Center = true; Obj.Name.Outline = true; Obj.Name.Color = MainCol; Obj.Name.Size = (IsMobile and 16 or 13)
            end

            Obj.Chams.Enabled = Toggles.VisChams.Value or Toggles.RainbowESP.Value
            Obj.Chams.Adornee = Char
            Obj.Chams.FillColor = MainCol
            Obj.Chams.OutlineColor = Color3.new(1,1,1)
        else 
            RemoveESP(Player) 
        end
    end
end)

-- TRIGGER BOT - EXACT COPY FROM OLD SCRIPT (NO MODIFICATIONS)
local triggerConnection = nil

Toggles.TriggerBot:OnChanged(function()
    if Toggles.TriggerBot.Value then
        if triggerConnection then triggerConnection:Disconnect() end
        
        triggerConnection = RunService.Heartbeat:Connect(function()
            if not Toggles.TriggerBot.Value then return end
            
            if Toggles.AimbotEnabled.Value then
                if StickyTarget and IsAlive(StickyTarget) then
                    if Toggles.WallCheck.Value then
                        local targetPart = StickyTarget.Character:FindFirstChild(Options.AimPart.Value)
                        if not targetPart or hasWallObstruction(targetPart) then
                            return
                        end
                    end
                    
                    task.wait(Options.TriggerDelay.Value / 1000)
                    mouse1click()
                end
            end
        end)
    else
        if triggerConnection then
            triggerConnection:Disconnect()
            triggerConnection = nil
        end
    end
end)

-- HITBOX LOOP
task.spawn(function()
    while task.wait(0.5) do
        if IS_RESTRICTED_GAME then break end 
        for _, p in pairs(Players:GetPlayers()) do
            if p ~= LocalPlayer and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
                local Root = p.Character.HumanoidRootPart
                if Toggles.HitboxEnabled.Value and not IsTeammate(p) and not IsInSafeZone(p) then
                    Root.Size = Vector3.new(Options.HitboxSize.Value, Options.HitboxSize.Value, Options.HitboxSize.Value)
                    Root.Transparency = Options.HitboxTransparency.Value
                    Root.Color = Options.HitboxColor.Value
                    Root.Material = Enum.Material.Neon
                else
                    Root.Size = Vector3.new(2, 2, 1)
                    Root.Transparency = 1
                end
            end
        end
    end
end)

-- UI SETTINGS
local MenuGroup = Tabs["UI Settings"]:AddLeftGroupbox("Menu")
MenuGroup:AddLabel("Menu bind"):AddKeyPicker("MenuKeybind", { Default = "RightShift", NoUI = true, Text = "Menu keybind" })
MenuGroup:AddButton("Unload", function() Library:Unload() end)
MenuGroup:AddLabel("Platform: " .. (IsMobile and "ðŸ“± Mobile" or "ðŸ’» PC"))

Library.ToggleKeybind = Options.MenuKeybind
ThemeManager:SetLibrary(Library)
SaveManager:SetLibrary(Library)
SaveManager:IgnoreThemeSettings()
SaveManager:SetIgnoreIndexes({ "MenuKeybind" })
ThemeManager:SetFolder("IntegratedAIO")
SaveManager:SetFolder("IntegratedAIO/main")
SaveManager:BuildConfigSection(Tabs["UI Settings"])
ThemeManager:ApplyToTab(Tabs["UI Settings"])
SaveManager:LoadAutoloadConfig()

Library:OnUnload(function()
    RunService:UnbindFromRenderStep("UnifiedRender")
    FOVCircle:Remove()
    Module.Cleanup()
    for p, _ in pairs(ESP_Cache) do RemoveESP(p) end
    if triggerConnection then triggerConnection:Disconnect() end
end)

Players.PlayerRemoving:Connect(RemoveESP)
Library:Notify("Full Integration Loaded | Mobile Support Active")