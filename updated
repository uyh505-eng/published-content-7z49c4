local repo = "https://raw.githubusercontent.com/deividcomsono/Obsidian/main/"
local Library = loadstring(game:HttpGet(repo .. "Library.lua"))()
local ThemeManager = loadstring(game:HttpGet(repo .. "addons/ThemeManager.lua"))()
local SaveManager = loadstring(game:HttpGet(repo .. "addons/SaveManager.lua"))()

local Options = Library.Options
local Toggles = Library.Toggles

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Camera = workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer

Library.ForceCheckbox = false
Library.ShowToggleFrameInKeybinds = true

local Window = Library:CreateWindow({
	Title = "mspaint | Tactical AIO",
	Footer = "Mobile Optimized | Lobby Detection",
	Icon = 95816097006870,
	NotifySide = "Right",
	ShowCustomCursor = false, 
    MobileButtonsSide = "Right"
})

local Tabs = {
	Main = Window:AddTab("Combat", "crosshair"),
    Visuals = Window:AddTab("Visuals", "eye"),
	["UI Settings"] = Window:AddTab("UI Settings", "settings"),
}

local IsMobile = UserInputService.TouchEnabled and not UserInputService.KeyboardEnabled

local FOVCircle = Drawing.new("Circle")
FOVCircle.Visible = false
FOVCircle.Thickness = 2
FOVCircle.NumSides = 64
FOVCircle.Filled = false
FOVCircle.Transparency = 1
FOVCircle.Color = Color3.fromRGB(255, 255, 255)

local StickyTarget = nil
local ESP_Cache = {}
local LOBBY_THRESHOLD = 450
local MAX_VISUAL_DISTANCE = 500

local function IsInSafeZone(Player)
    if not Player or not Player.Character then return false end
    local Root = Player.Character:FindFirstChild("HumanoidRootPart")
    if not Root then return false end
    
    local Pos = Root.Position

    local function getCenter(folderPath)
        if not folderPath then return nil end
        local part = folderPath:FindFirstChildWhichIsA("BasePart", true)
        return part and part.Position
    end

    local targetFolders = {
        workspace:FindFirstChild("Lobby"),
        workspace.Lobby:FindFirstChild("Hub"),
        workspace.Lobby:FindFirstChild("WaitingRoom"),
        workspace.Lobby:FindFirstChild("ShootingRange"),
        workspace.Lobby.ShootingRange:FindFirstChild("Extra"),
        workspace.Lobby.ShootingRange:FindFirstChild("Important")
    }

    for _, folder in pairs(targetFolders) do
        if folder then
            local center = getCenter(folder)
            if center and (Pos - center).Magnitude < LOBBY_THRESHOLD then
                return true
            end
        end
    end

    return false
end

local function IsTeammate(Player)
    if not Toggles.TeamCheck.Value then return false end
    
    if Player.Team == LocalPlayer.Team and Player.Team ~= nil then
        return true
    end
    
    if Player:GetAttribute("Team") == LocalPlayer:GetAttribute("Team") and Player:GetAttribute("Team") ~= nil then
        return true
    end

    local Char = Player.Character
    if Char then
        local HRP = Char:FindFirstChild("HumanoidRootPart")
        if HRP and (HRP:FindFirstChild("teamatelabel") or HRP:FindFirstChild("TeammateLabel") or HRP:FindFirstChild("Marker")) then
            return true
        end
        
        local Head = Char:FindFirstChild("Head")
        if Head and (Head:FindFirstChild("TeammateLabel") or Head:FindFirstChild("FriendMarker")) then
            return true
        end

        for _, child in pairs(Char:GetDescendants()) do
            if child:IsA("BillboardGui") and (child.Name:lower():find("team") or child.Name:lower():find("friend")) then
                return true
            end
        end
    end
    
    return false
end

local function hasWallObstruction(targetPart)
    if not Toggles.WallCheck.Value then return false end
    
    local MyChar = LocalPlayer.Character
    local MyRoot = MyChar and MyChar:FindFirstChild("HumanoidRootPart")
    if not MyRoot then return true end
    
    local rayParams = RaycastParams.new()
    rayParams.FilterDescendantsInstances = {MyChar, targetPart.Parent}
    rayParams.FilterType = Enum.RaycastFilterType.Exclude
    rayParams.IgnoreWater = true
    
    local origin = MyRoot.Position
    local direction = (targetPart.Position - origin)
    
    local rayResult = workspace:Raycast(origin, direction, rayParams)
    
    if rayResult and rayResult.Instance then
        local hitPart = rayResult.Instance
        if hitPart:IsDescendantOf(targetPart.Parent) then
            return false
        end
        return true
    end
    
    return false
end

local function GetClosestTarget()
    if IsInSafeZone(LocalPlayer) then return nil end
    
    local Target, Closest = nil, Options.AimbotFOV.Value
    
    for _, p in pairs(Players:GetPlayers()) do
        if p ~= LocalPlayer and p.Character and p.Character:FindFirstChild("HumanoidRootPart") and p.Character:FindFirstChild("Humanoid") and p.Character.Humanoid.Health > 0 then
            
            if IsInSafeZone(p) then continue end
            
            local targetRoot = p.Character.HumanoidRootPart
            if IsTeammate(p) then continue end
            if hasWallObstruction(targetRoot) then continue end
            
            local Pos, OnScreen = Camera:WorldToViewportPoint(targetRoot.Position)
            if OnScreen then
                local MouseLoc = IsMobile and Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2) or UserInputService:GetMouseLocation()
                local Dist = (Vector2.new(Pos.X, Pos.Y) - MouseLoc).Magnitude
                if Dist < Closest then
                    Closest = Dist
                    Target = p
                end
            end
        end
    end
    return Target
end

task.spawn(function()
    while task.wait(0.2) do
        for _, p in pairs(Players:GetPlayers()) do
            if p ~= LocalPlayer and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
                local Root = p.Character.HumanoidRootPart
                local Hum = p.Character:FindFirstChild("Humanoid")
                
                if Toggles.HitboxEnabled.Value and not IsTeammate(p) and not IsInSafeZone(p) then
                    if Hum and not Hum.Sit then
                        Root.Size = Vector3.new(Options.HitboxSize.Value, Options.HitboxSize.Value, Options.HitboxSize.Value)
                        Root.Transparency = Options.HitboxTransparency.Value
                        Root.Color = Options.HitboxColor.Value
                        Root.Material = Enum.Material.Neon
                    end
                else
                    Root.Size = Vector3.new(2, 2, 1)
                    Root.Transparency = 1
                end
            end
        end
    end
end)

local function RemoveESP(Player)
    if ESP_Cache[Player] then
        for _, obj in pairs(ESP_Cache[Player]) do
            if typeof(obj) == "table" then 
                for _, sub in pairs(obj) do 
                    if sub and sub.Remove then sub:Remove() end
                end
            elseif typeof(obj) == "Instance" then 
                obj:Destroy()
            elseif obj and obj.Remove then 
                obj:Remove() 
            end
        end
        ESP_Cache[Player] = nil
    end
end

local AimGroup = Tabs.Main:AddLeftGroupbox("Aimbot Settings")
AimGroup:AddToggle("AimbotEnabled", { Text = "Enabled", Default = false })
AimGroup:AddToggle("AlwaysOn", { Text = "Always On (Auto-Lock)", Default = false })
AimGroup:AddDropdown("AimMethod", { Values = {"Camera", "Mouse", "Hybrid"}, Default = 3, Text = "Aim Method" })
AimGroup:AddToggle("TeamCheck", { Text = "Team Check", Default = true })
AimGroup:AddToggle("WallCheck", { Text = "Visibility Check", Default = true })
AimGroup:AddSlider("AimbotFOV", { Text = "FOV Size", Default = 150, Min = 0, Max = 1000 })
AimGroup:AddSlider("Smoothing", { Text = "Smoothness", Default = 2, Min = 1, Max = 20, Rounding = 1 })
AimGroup:AddSlider("Prediction", { Text = "Prediction", Default = 0, Min = 0, Max = 5, Rounding = 1 })
AimGroup:AddDropdown("AimPart", { Values = {"Head", "HumanoidRootPart"}, Default = 1, Text = "Target Part" })
if not IsMobile then
    AimGroup:AddLabel("Aim Keybind"):AddKeyPicker("AimKey", { Default = "MB2", Mode = "Hold", Text = "Aim Lock" })
end

local KillGroup = Tabs.Main:AddRightGroupbox("KILL V1 (OP)")
KillGroup:AddToggle("KillV1Enabled", { Text = "Enabled", Default = false })
KillGroup:AddSlider("KillHeight", { Text = "Height Above Head", Default = 6, Min = 2, Max = 20, Rounding = 1 })

local HitGroup = Tabs.Main:AddRightGroupbox("Hitbox Expander")
HitGroup:AddToggle("HitboxEnabled", { Text = "Enabled", Default = false })
HitGroup:AddSlider("HitboxSize", { Text = "Hitbox Size", Default = 2, Min = 2, Max = 20, Rounding = 1 })
HitGroup:AddSlider("HitboxTransparency", { Text = "Hitbox Transparency", Default = 0.5, Min = 0, Max = 1, Rounding = 1 })
HitGroup:AddLabel("Hitbox Color"):AddColorPicker("HitboxColor", { Default = Color3.fromRGB(255, 0, 0) })

local VisGroup = Tabs.Visuals:AddLeftGroupbox("Visuals")
VisGroup:AddToggle("VisBox", { Text = "Corner Brackets", Default = false })
VisGroup:AddToggle("VisSkeleton", { Text = "Skeleton ESP", Default = false })
VisGroup:AddToggle("VisHealth", { Text = "Dynamic Health Bar", Default = false })
VisGroup:AddToggle("VisName", { Text = "Tactical Info Tags", Default = false })
VisGroup:AddToggle("VisTracer", { Text = "Tracers", Default = false })
VisGroup:AddToggle("VisHead", { Text = "Head Indicator", Default = false })
VisGroup:AddToggle("VisChams", { Text = "Player Chams", Default = false })
VisGroup:AddSlider("VisMaxDist", { Text = "Max ESP Distance", Default = 500, Min = 100, Max = 5000, Rounding = 0 })

local ColorGroup = Tabs.Visuals:AddRightGroupbox("Colors")
ColorGroup:AddLabel("Enemy Color"):AddColorPicker("EnemyCol", { Default = Color3.fromRGB(255, 50, 50) })
ColorGroup:AddLabel("Team Color"):AddColorPicker("TeamCol", { Default = Color3.fromRGB(50, 255, 50) })

RunService:BindToRenderStep("MspaintAim", Enum.RenderPriority.Camera.Value + 1, function()
    local LocalInLobby = IsInSafeZone(LocalPlayer)
    
    FOVCircle.Visible = Toggles.AimbotEnabled.Value and not LocalInLobby
    FOVCircle.Filled = false
    FOVCircle.Transparency = 1
    
    if IsMobile then
        FOVCircle.Position = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)
    else
        FOVCircle.Position = UserInputService:GetMouseLocation()
    end
    FOVCircle.Radius = Options.AimbotFOV.Value

    local AimActive = not LocalInLobby and Toggles.AimbotEnabled.Value and (Toggles.AlwaysOn.Value or (not IsMobile and Options.AimKey and Options.AimKey:GetState()) or IsMobile)
    
    if AimActive then
        local NewTarget = GetClosestTarget()
        if NewTarget then StickyTarget = NewTarget end
    end

    if StickyTarget then
        local Hum = StickyTarget.Character and StickyTarget.Character:FindFirstChild("Humanoid")
        local targetRoot = StickyTarget.Character and StickyTarget.Character:FindFirstChild("HumanoidRootPart")
        
        if not StickyTarget.Character or not Hum or Hum.Health <= 0 or IsInSafeZone(StickyTarget) or hasWallObstruction(targetRoot) then 
            StickyTarget = nil 
        end
    end
    if not AimActive then StickyTarget = nil end

    if Toggles.KillV1Enabled.Value and StickyTarget and StickyTarget.Character and not LocalInLobby then
        local MyRoot = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
        local TargetHead = StickyTarget.Character:FindFirstChild("Head")
        if MyRoot and TargetHead then
            local Pos = TargetHead.Position + Vector3.new(0.01, Options.KillHeight.Value, 0.01)
            MyRoot.CFrame = CFrame.lookAt(Pos, TargetHead.Position)
            MyRoot.Anchored = true
        end
    else
        if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
            LocalPlayer.Character.HumanoidRootPart.Anchored = false
        end
    end

    if AimActive and StickyTarget and not Toggles.KillV1Enabled.Value then
        local Part = StickyTarget.Character:FindFirstChild(Options.AimPart.Value)
        if Part and not hasWallObstruction(Part) then
            local PredPos = Part.Position + (Part.Velocity * (Options.Prediction.Value / 10))
            local ScreenPos, OnScreen = Camera:WorldToViewportPoint(PredPos)
            
            if Options.AimMethod.Value == "Camera" or Options.AimMethod.Value == "Hybrid" then
                Camera.CFrame = Camera.CFrame:Lerp(CFrame.new(Camera.CFrame.Position, PredPos), 1/Options.Smoothing.Value)
            end
            
            if not IsMobile and (Options.AimMethod.Value == "Mouse" or Options.AimMethod.Value == "Hybrid") and mousemoverel then
                local MousePos = UserInputService:GetMouseLocation()
                mousemoverel((ScreenPos.X - MousePos.X) / Options.Smoothing.Value, (ScreenPos.Y - MousePos.Y) / Options.Smoothing.Value)
            end
        end
    end
    
    for _, Player in pairs(Players:GetPlayers()) do
        if Player == LocalPlayer then continue end
        
        local Char = Player.Character
        local Root = Char and Char:FindFirstChild("HumanoidRootPart")
        local Hum = Char and Char:FindFirstChild("Humanoid")
        
        if not Root or not Hum or Hum.Health <= 0 then 
            RemoveESP(Player)
            continue 
        end

        local RealDist = (Camera.CFrame.Position - Root.Position).Magnitude
        
        if IsInSafeZone(Player) or RealDist > Options.VisMaxDist.Value then
            RemoveESP(Player)
            continue
        end
        
        local Pos, OnScreen = Camera:WorldToViewportPoint(Root.Position)
        
        if OnScreen then
            if not ESP_Cache[Player] then
                ESP_Cache[Player] = {
                    Corners = { Drawing.new("Line"), Drawing.new("Line"), Drawing.new("Line"), Drawing.new("Line"), Drawing.new("Line"), Drawing.new("Line"), Drawing.new("Line"), Drawing.new("Line") },
                    Skeleton = { Drawing.new("Line"), Drawing.new("Line"), Drawing.new("Line"), Drawing.new("Line"), Drawing.new("Line") },
                    HealthBar = Drawing.new("Line"),
                    Name = Drawing.new("Text"),
                    Tracer = Drawing.new("Line"),
                    HeadDot = Drawing.new("Circle"),
                    Chams = Instance.new("Highlight", game:GetService("CoreGui"))
                }
            end
            
            local Obj = ESP_Cache[Player]
            local MainCol = IsTeammate(Player) and Options.TeamCol.Value or Options.EnemyCol.Value
            local Scale = 1/Pos.Z * 1000
            local W, H = 2.5 * Scale, 4.5 * Scale
            local X, Y = Pos.X - W/2, Pos.Y - H/2

            for i, v in pairs(Obj.Corners) do v.Visible = Toggles.VisBox.Value; v.Color = MainCol; v.Thickness = IsMobile and 2 or 1 end
            if Toggles.VisBox.Value then
                local L = W/4
                Obj.Corners[1].From = Vector2.new(X, Y); Obj.Corners[1].To = Vector2.new(X+L, Y)
                Obj.Corners[2].From = Vector2.new(X, Y); Obj.Corners[2].To = Vector2.new(X, Y+L)
                Obj.Corners[3].From = Vector2.new(X+W, Y); Obj.Corners[3].To = Vector2.new(X+W-L, Y)
                Obj.Corners[4].From = Vector2.new(X+W, Y); Obj.Corners[4].To = Vector2.new(X+W, Y+L)
                Obj.Corners[5].From = Vector2.new(X, Y+H); Obj.Corners[5].To = Vector2.new(X+L, Y+H)
                Obj.Corners[6].From = Vector2.new(X, Y+H); Obj.Corners[6].To = Vector2.new(X, Y+H-L)
                Obj.Corners[7].From = Vector2.new(X+W, Y+H); Obj.Corners[7].To = Vector2.new(X+W-L, Y+H)
                Obj.Corners[8].From = Vector2.new(X+W, Y+H); Obj.Corners[8].To = Vector2.new(X+W, Y+H-L)
            end

            for _, v in pairs(Obj.Skeleton) do v.Visible = Toggles.VisSkeleton.Value; v.Color = Color3.new(1,1,1); v.Thickness = IsMobile and 2 or 1 end
            if Toggles.VisSkeleton.Value then
                local function GB(n) return Char:FindFirstChild(n) and Camera:WorldToViewportPoint(Char[n].Position) end
                local H, T, LL, RL, LA, RA = GB("Head"), GB("UpperTorso"), GB("LeftLowerLeg"), GB("RightLowerLeg"), GB("LeftLowerArm"), GB("RightLowerArm")
                if H and T and LL and RL and LA and RA then
                    Obj.Skeleton[1].From = Vector2.new(H.X, H.Y); Obj.Skeleton[1].To = Vector2.new(T.X, T.Y)
                    Obj.Skeleton[2].From = Vector2.new(T.X, T.Y); Obj.Skeleton[2].To = Vector2.new(LL.X, LL.Y)
                    Obj.Skeleton[3].From = Vector2.new(T.X, T.Y); Obj.Skeleton[3].To = Vector2.new(RL.X, RL.Y)
                    Obj.Skeleton[4].From = Vector2.new(T.X, T.Y); Obj.Skeleton[4].To = Vector2.new(LA.X, LA.Y)
                    Obj.Skeleton[5].From = Vector2.new(T.X, T.Y); Obj.Skeleton[5].To = Vector2.new(RA.X, RA.Y)
                end
            end

            Obj.HealthBar.Visible = Toggles.VisHealth.Value
            if Toggles.VisHealth.Value then
                Obj.HealthBar.From = Vector2.new(X-5, Y+H); Obj.HealthBar.To = Vector2.new(X-5, Y+H-(Hum.Health/Hum.MaxHealth*H))
                Obj.HealthBar.Color = Color3.fromHSV(math.clamp(Hum.Health/Hum.MaxHealth,0,0.35),0.9,0.9); Obj.HealthBar.Thickness = IsMobile and 3 or 2
            end

            Obj.Tracer.Visible = Toggles.VisTracer.Value
            if Toggles.VisTracer.Value then
                Obj.Tracer.From = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y); Obj.Tracer.To = Vector2.new(Pos.X, Pos.Y); Obj.Tracer.Color = MainCol; Obj.Tracer.Thickness = IsMobile and 2 or 1
            end

            Obj.Name.Visible = Toggles.VisName.Value
            if Toggles.VisName.Value then
                Obj.Name.Text = Player.Name:upper() .. " [" .. math.floor(RealDist) .. "M]"
                Obj.Name.Position = Vector2.new(Pos.X, Y-20); Obj.Name.Center = true; Obj.Name.Outline = true; Obj.Name.Size = IsMobile and 14 or 13; Obj.Name.Color = MainCol
            end
            
            Obj.HeadDot.Visible = Toggles.VisHead.Value
            if Toggles.VisHead.Value and Char:FindFirstChild("Head") then
                local HPos = Camera:WorldToViewportPoint(Char.Head.Position)
                Obj.HeadDot.Position = Vector2.new(HPos.X, HPos.Y)
                Obj.HeadDot.Radius = Scale * (IsMobile and 0.5 or 0.7)
                Obj.HeadDot.Color = MainCol
                Obj.HeadDot.Filled = false
                Obj.HeadDot.Transparency = 1
                Obj.HeadDot.Thickness = IsMobile and 2 or 2
                Obj.HeadDot.NumSides = 32
            end
            
            Obj.Chams.Enabled = Toggles.VisChams.Value
            Obj.Chams.Adornee = Char
            Obj.Chams.FillColor = MainCol
            Obj.Chams.FillTransparency = 0.5
            Obj.Chams.OutlineColor = MainCol
            Obj.Chams.OutlineTransparency = 0
        else 
            RemoveESP(Player) 
        end
    end
end)

local MenuGroup = Tabs["UI Settings"]:AddLeftGroupbox("Menu")
MenuGroup:AddLabel("Menu bind"):AddKeyPicker("MenuKeybind", { Default = "RightShift", NoUI = true, Text = "Menu keybind" })
MenuGroup:AddButton("Unload", function() Library:Unload() end)
MenuGroup:AddLabel("Platform: " .. (IsMobile and "ðŸ“± Mobile" or "ðŸ’» PC"))

Library.ToggleKeybind = Options.MenuKeybind
ThemeManager:SetLibrary(Library)
SaveManager:SetLibrary(Library)
SaveManager:IgnoreThemeSettings()
SaveManager:SetIgnoreIndexes({ "MenuKeybind" })
ThemeManager:SetFolder("MspaintTactical")
SaveManager:SetFolder("MspaintTactical/main")
SaveManager:BuildConfigSection(Tabs["UI Settings"])
ThemeManager:ApplyToTab(Tabs["UI Settings"])
SaveManager:LoadAutoloadConfig()

Library:OnUnload(function()
    RunService:UnbindFromRenderStep("MspaintAim")
    FOVCircle:Remove()
    for p, _ in pairs(ESP_Cache) do RemoveESP(p) end
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        LocalPlayer.Character.HumanoidRootPart.Anchored = false
    end
end)

Players.PlayerRemoving:Connect(RemoveESP)
Library:Notify("Tactical AIO | Distance Limit Added")